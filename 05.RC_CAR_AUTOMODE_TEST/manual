---------------------------------------------------------------
패치 노트 (요약)
---------------------------------------------------------------
| 버전     | 핵심 변화                 |
| ------- | ----------------------- |
| **v1**  | 단순 Pivot 로직           |
| **v2**  | 임계 히스테리시스           |
| **v3**  | 중심추종(P) 구조 도입       |
| **v4**  | Pivot vs Arc 모드 분리    |
| **v5**  | 단순/반응성 중심 리빌드      |
| **v6**  | 중앙추종 + Pivot 통합      |
| **v7**  | ΔC 개념 준비              |
| **v8**  | ΔC 기반 ARC 조기 진입      |
| **v9**  | 전진 고정 + 부드러운 벽추종  |
| **v10** | ΔC 스무딩·스트릭 설정       |
| **v11** | Gate + ExitTune 시스템    |
| **v12** | 연속커브·방지턱 정식 지원     |
| **v13** | 실차 수준 통합 안정화 완성    |

---------------------------------------------------------------
패치 노트 (상세 내용)
---------------------------------------------------------------
v1 — 초기 버전: 단순 Pivot 기반 벽추종
     전방 임계값 1개로 코너 진입 판단
     좌/우는 단지 “어느 쪽으로 돌지” 선택용
     상태는 ST_CLEAR / ST_TURNING 두 개뿐
     회전 유지도 시간 기반 고정
문제: 직선에서 출렁임, ㄱ자 코너에서 과회전, 반커브 오판

v2 — 히스테리시스 도입
     FRONT_ENTER / FRONT_CLEAR 두 임계값 분리
     피벗 재진입 억제 → 진동 감소
     회전 종료 순간의 흔들림 감소
문제: 그래도 반커브 판단 불안정, 턴 타이밍 고정

v3 — Deadzone + 좌우 밸런스 보정
     좌/우 사이드 센서 차이를 사용해 기본 중심 유지 로직 추가
     작은 노이즈는 DEAD로 무시
     직선 안정성이 증가
문제: 커브에서 속도 때문에 앞 센서 C 변화가 빨라져도 동적 판단 불가

v4 — 회전 모드 분리 (Pivot vs Arc의 기원)
     Pivot은 급코너, Arc는 완만 커브로 분리
     FRONT_PIVOT / FRONT_ARC 2개 임계값 사용 시작
     Arc 구간에서는 전진 유지 + 차동 조향
문제: 두 모드의 전환 기준이 정적으로 고정됨

v5 — 단순화 모드 (반응성 강화 버전)
     기존 복잡한 상태머신을 대폭 정리
     “전진 중심” 철학 + 반응속도 우선 로직
     센서 변화에 빠르게 반응하도록 구성
문제: 단순해진 대신 반커브·U자 구간에서 튜닝 부족

v6 — 중앙 추종 + Pivot 통합형
     중심 추종 로직과 Pivot 조건을 통일
     EMA/Rate limit 개념으로 센서 안정화
     반응성 + 안정성 목표
문제: 여전히 반커브에서 ARC 조기 진입 불가

v7 — ΔC 개념(전방 변화율) 도입 준비
     프레임별 C 변화를 기록
     앞으로 ΔC 기반 동적 판단을 위한 토대 마련
     턴 조건을 시간·거리 → 거리 변화율 기반으로 확장
문제: 실제 활용은 부족, 단순 기록 수준

v8 — ΔC 기반 ARC 조기 진입
     ΔC < 0(빠르게 좁아짐) → ARC/Pivot 임계값 조정
     속도 증가에 따른 코너 오판 해결
     반커브·U자에서 훨씬 자연스러운 진입
문제: 단일 ΔC는 노이즈에 취약 → 스무딩 필요

v9 — 부드러운 벽추종 + 전진 고정형
     역회전 금지: 반드시 전진 유지
     미세 조향은 “가까운 벽의 반대 바퀴만 줄임”
     CENTER_TOL, DEAD, CLAMP 등
     직선 안정성 강화
     소프트/하드 조향 단계로 커브 시작이 부드러워짐
문제: 고속 커브 진입 로직 부족, U자 판단 없음

v10 — ΔC 버퍼(3프레임 평균) 도입
      dC_buf[3] 평균으로 변화율 스무딩
      ΔC FAST_CLOSE / FAST_OPEN 스트릭 추적
      “급 닫힘(U자)” vs “급 열림(출구)” 인식 가능
      ARC 최소시간 튜닝에 활용 가능해짐
문제: Arc 종료·시작 조건은 아직 단순

v11 — Gate + ExitTune 모델 탄생
      코너 진입 게이트:
      ΔC 스트릭 기반으로 PIVOT/ARC 임계값 조정
      출구 조기복귀:
      ΔC_fast_open + 바깥 센서 개방 조건
      Arc Phase 단계적 약화로 오버턴 방지
문제: 연속 커브(ㄱㄱㄱ)에서 재결정 속도 부족

v12 — 연속커브/방지턱 정식 지원
      연속커브 모드(in_chain)
      Pivot 완화
      결정주기 단축(30ms → 16ms)
      DRIVE 홀드 축소
      방지턱 감지:
      ΔC 양/음 교차 + C 범위로 검출
      감지 시 speedUp + 턴 일시 봉인
      Arc 종료 조건 보수화 및 정교화
문제: 전체 구조가 매우 안정적이지만 코드가 복잡해짐

v13 — 실차용 통합 최종 구조
      v12 전 기능 유지 + 안정성·보수성 강화
      정지 금지(FRONT_TOO_CLOSE) 비상 Pivot 확립
      ΔC 기반 임계 보정 범위 조정
      Arc 출구 판단(센터·외측·CLEAR_TH)의
      3중 게이트 논리 완성
      Arc bias의 단계적 소멸(s_arc_phase)
      방지턱·연속커브·속도제어·게이트가 하나의 자연스러운 흐름으로 통합
결론: 실제 코스 완주가 가능한 수준의 완성도

---------------------------------------------------------------
코드 상세 설명
---------------------------------------------------------------
automode 1
1) 초음파 3개(L/F/R) 기반 벽 추종(Wall-Follow) + 기본 코너 회전 준비 로직
2) PD 조향, 전방 TTC 기반 속도 스케줄링, E-STOP, 가감속 램핑

automode 2
1) 벽 추종 로직 단순화
→ PD 제어 제거, 대신 좌/우 거리 차(diff) 기반의 간단한 미세조향 적용
2) 전방 거리 기반 상태머신 도입
→ 전방이 가까움(NEAR) / 안전(CLEAR) 을 히스테리시스로 판정하여
3) 주행 모드 전환 안정성 확보
강제 코너 턴(State Machine 기반)
→ 좌/우 거리 차가 크면 코너로 간주하고
4) 정지→방향핀 전환→PWM 강제 세팅→TURN_MS 유지
5) 방식으로 “확실한 제자리 회전” 수행
6) 센서 노이즈 보호 및 최소 안전치 적용
→ MIN_VALID_CM, DEAD_BAND, CLEAR/NEAR 프레임 2회 확인 등
7) 복잡한 속도 스케줄·가감속·TTC 제거 → 구조 단순화
→ 벽 추종/코너 판단 흐름을 직관적으로 만들고, 초보 튜닝 중심 설계

automode 3
1) 가장 단순한 룰 기반 자율주행 실험 버전
→ PD·램핑·상태머신 모두 제거하고,
2) “앞 막힘 → 한쪽 비었으면 피벗 턴 → 아니면 정지 → 기본은 느린 직진” 이라는 4단계 규칙만으로 구성
3) 완전 단순화된 피벗 회전 로직
→ 전방 ≤ FRONT_BLOCK_CM이면 좌/우 중 비어있는 쪽으로 제자리 회전
4) 속도 제어 극단적 간소화
→ 직진은 CREEP 속도로 고정
→ 턴도 고정 PWM 값 사용
5) 센서 보호 최소 기능만 유지
→ 초근접값 보정(C < 5 → 400)

automode 4
1) 전방 거리 기반의 단순한 2상태 구조
→ 전진(ST_CLEAR)과 정지 피벗 회전(ST_TURNING)을 명확히 구분해 코너링 안정성 확보
2) 회전 안정화 로직 강화
→ 최소 회전 시간(TURN_MS), 전방 히스테리시스(D_TURN_ENTER/D_TURN_EXIT), 
  좌우 균형 조건(SIDE_BAL_DB) 등을 적용해 “충분히 돌아갈 때까지 회전을 유지”
3) 재진입 홀드(NO_TURN_HOLD_MS) 를 도입해 회전 종료 직후 다시 회전으로 들어가는 튐·진동 문제 방지
4) 좌/우 센서는 회전 방향 선택과 정렬 종료 조건에만 사용하여 구조를 단순화하고 전방 중심 로직 강화

automode 5
1) “앞 막히면 90도 회전 → 다시 직진”이라는 단순 전략을 유지하면서, 실제 주행에서 튀는 현상을 줄이기 위한 “안전·노이즈 완화 패치 버전”
2) 전방 센서에 EMA(지수 이동 평균) 필터를 적용해, 순간 튀는 거리값 때문에 불필요하게 회전/정지하지 않도록 안정화
3) PWM 을 바로 바꾸지 않고 램핑(PWM_RAMP_STEP) 으로 서서히 변화시켜, 급가속·급감속으로 인한 차체 흔들림과 바퀴 튐 현상 완화
4) 전방/좌/우 중 “가장 여유 있는 방향 선택” + MARGIN_CM + CHOICE_STREAK 로
   방향 선택을 여러 프레임 확인 후 확정 → 회전 방향이 프레임마다 바뀌는 좌우 덜컹거림(플리플롭) 방지
5) 회전 종료 후 NO_TURN_HOLD_MS 재진입 홀드를 둬서 
   막 회전 끝내고 다시 바로 회전 상태로 들어가는 불안정한 반복 회전을 차단

automode 6
1) “기본 직진·코너링 + 충돌 가드 시퀀스”를 결합한 안전 중심 자율주행 버전
→ 평소에는 직진/코너링, 위험 거리(코앞) 에서는 별도 긴급 시나리오로 탈출
2) 우측 벽 기준 직진 주행 + 부드러운 회전 진입
→ 앞/좌/우가 40cm 이내면 감속, 멀면 가속
→ 우측 기준 거리(RIGHT_REF_CM)로 좌측 속도만 미세 보정
→ 전방이 FRONT_STOP_CM 이하면 먼 쪽으로 회전 절차(감속 → 방향 전환) 진입
3) 코너링 상태 분리
→ ST_DECEL_FOR_RIGHT/LEFT 에서 회전 전 감속 틱 확보 후
ST_TURN_RIGHT/LEFT 로 들어가 앞·옆 거리 비교(front > side) 시 직진 복귀
4) 충돌 가드(코앞 근접) 전용 상태머신 도입
→ front_cm ≤ CRASH_CM 이 연속 CRASH_STREAK_N 회 면 
  급감속(ST_EMERG_BRAKE) → 후진(ST_BACKOFF) → 빈 쪽으로 피벗(ST_PIVOT_AWAY_R/L)
  순서로 탈출, 이후 CRASH_COOLDOWN_TICKS 동안 재발동 금지

automode 7
1) 직진 구간 P조향 정식 도입
→ 좌/우 거리 차(right−left)를 이용한 단순 P 제어로, 직선·코너 직후에 중앙을 더 잘 따라가도록 개선
2) 주행 전체를 더 “보수적·안전하게” 재튜닝
→ WALL_NEAR_CM=65, FRONT_STOP_CM=55 등 임계값을 키워 더 멀리서 미리 감속·회전 준비하게 만들어 코너 진입을 완화
3) 충돌 가드 시퀀스 유지 + 파라미터 재조정
→ v6의 급정지 → 후진 → 빈쪽 피벗 구조는 유지하되,
  CRASH, DECEL_TICKS, BACKOFF_TICKS, PIVOT_TICKS, COOLDOWN 값을 조정해
  한 번 가드가 걸리면 충분히 뒤로 빠지고 크게 돌아 나오게 변경

automode 8
1) 충돌 가드(급정지·후진·빈쪽 피벗) 로직을 전부 제거하고,
   직진(ST_STRAIGHT) + 회전 준비(ST_DECEL_) + 회전(ST_TURN_) 만 남김
2) 직진 구간은 v7과 같은 P-조향 + 근접 시 감속 구조를 유지하면서,
   WALL_NEAR_CM·FRONT_STOP_CM·감속/회전 틱을 다시 튜닝해 부드러운 코너 진입을 목표
3) 회전 종료 조건을 “전방이 충분히 열려 있음(FRONT_CLEAR_CM 이상)” + “좌우 센서가 CENTER_TOL_CM 안에서 정렬됨” 이라는
   통일된 중앙 정렬 기준(center_streak) 으로 바꿔, 코너 이후 중앙 복귀 품질을 개선

automode 9
1) “항상 전진만 하면서, 감속 없이 부드럽게 벽을 따라가는” 비감속형 벽추종
  → 후진·피벗·강한 회전 없이, 속도를 유지한 채 안쪽 바퀴만 살짝 줄여서 방향만 조정
2) 코너 처리도 전진 조향으로 해결
→ 전방이 FRONT_STOP_CM 이하가 되면 더 열린 쪽(R>L → 우측 / L≥R → 좌측)으로 상태 전환
3) 안쪽 바퀴만 여러 틱(HARD_STEER_TICKS) 연속 speedDown 해서 전진하면서 꺾는 코너링
4) 직선 구간은 “속도 동결 + P-유사 조향”
→ auto_motor_speedUp/Down 으로 전체 속도를 흔들지 않고,
  가까운 벽의 반대쪽 바퀴만 1틱씩 줄이는 방식(SOFT_STEER_TICKS) 으로 중앙 추종
5) 코너 근처 ‘준비 밴드(FRONT_PREP_BAND)’에서 속도 동결
→ 전방이 너무 가까워지면 코너 직전에 Up/Down 자체를 금지하여 코너 진입 시 속도 요동/오실레이션을 억제
6) 회전 종료 조건도 “전진 조향 관점”으로 단순화
→ F ≥ FRONT_CLEAR_CM 이고 L≈R(CENTER_TOL_CM 안)이면 CRUISE로 복귀 → 다시 중앙 벽추종

automode 10
1) “절대 멈추지 않고(정지·후진 없음) 코스를 완주하는” 최소 자율주행 로직
→ 너무 가까워도 stop/motor_stop 없이, 항상 전진 + Pivot/Arc 조합으로만 회피
2) Pivot(제자리 90°) + Arc(전진 커브) 이중 회전 모드 도입
→ 전방이 많이 막히면 Pivot, 덜 막히면 Arc 로 선택해서 급코너·완만코너를 각각 다른 방식으로 처리
3) 결정 안정화 메커니즘 3종 적용
→ DECIDE_EVERY_MS: 턴 방향/모드 판단 주기를 제한
→ HOLD_DRIVE_MS / HOLD_TURN_MS: 한 번 상태에 들어가면 최소 시간 유지 → 상태 깜빡임 방지
→ dir_vote (±2 스트릭): L/R 비교를 누적해서, 한두 번 튀는 센서값에 방향이 바뀌지 않도록 함
4) TURN 중에도 “멈추지 않고” 속도·곡률 유지
→ Pivot 종료 후 곧바로 저속 전진으로 복귀
→ Arc 중에는 항상 drive_forward() + 안쪽 바퀴 speedDown() 재적용으로 곡률 유지
5) 거리 기반 속도 거버너
→ L/R/C 중 최소값에 따라 auto_motor_slow / speedUp 호출로 코너·협곡에서는 자동 감속, 여유 있을 때만 가속하는 기본 안전장치
6) 기동 초반 STARTUP TURN BAN
→ 시작 후 일정 시간(약 1초) 동안은 어떤 턴도 금지하고 저속 직진만 하게 하여, 출발 시 바로 회전해 벽에 붙는 상황을 예방

automode 11
1) v10의 “No-Stop + Pivot/Arc + 상태안정화 구조”는 유지하면서,
   여기에 [ΔC = 전방 거리 변화율]을 도입해 “반커브·출구”를 더 똑똑하게 처리
2) 전방 거리 변화율 ΔC(SMA3) + 연속 스트릭 도입
→ dC_avg <= DC_FAST_CLOSE_CM 이 여러 틱 지속되면 급폐쇄(급커브/U자) 로 인식
→ dC_avg >= DC_FAST_OPEN_CM 이 여러 틱 지속되면 급개방(출구/가속 구간) 으로 인식
3) ΔC에 따라 Pivot/Arc 진입 임계값을 동적으로 조정
→ 급폐쇄 지속 시: FRONT_PIVOT/ARC 임계를 위로 올려서, 더 일찍 Pivot/Arc 진입 → 반커브/급커브에서 늦게 도는 문제 완화
→ 급개방 지속 시: ARC 임계를 낮춰서 불필요한 Arc 재진입 억제 → 출구에서 쓸데없이 다시 커브로 빠지는 현상 감소
4) Arc 탈출 조건도 ΔC 기반으로 미세조정
→ 급개방 스트릭이 있을 땐 FRONT_CLEAR 를 살짝 낮춰 “조금만 열려도 빨리 DRV로 복귀” → 출구에서 Arc가 너무 오래 끌리는 현상 완화
5) 기존 안정화 메커니즘 유지
→ No-Stop 정책(정지·후진 없음)
→ Pivot/Arc 이중 회전 모드
→ DECIDE_EVERY_MS, HOLD_DRIVE_MS/HOLD_TURN_MS, 방향 스트릭(dir_vote ±2), 거리 기반 속도 거버너 구조는 그대로 유지

automode 12
1) v11의 ΔC 기반 No-Stop Pivot/Arc 구조는 유지하면서, “게이트(Gate) + 출구(Exit) 튜닝”으로 연속 커브·방지턱·출구 구간 주행 품질을 정리
2) 연속 커브(arc chain) 대응
→ 직전 턴 이후 일정 시간 안을 “연속 커브 구간”으로 보고 
  의사결정 주기(DECIDE_EVERY_MS ↓)와 DRV 유지 시간(HOLD_DRIVE_MS ↓)을 줄여
  ㄱ-ㄱ-ㄱ처럼 연달아 나오는 코너에서 더 빠르게 재결정/재진입
3) 방지턱(bump) 감지 + 자동 가속 구간
→ ΔC 패턴(±로 흔들리며 평균은 거의 0) + 거리 범위(45~85cm)로 방지턱 구간을 감지하고, 
  그 동안은 drive_forward + speedUp 위주로 속도 유지/회복에 집중(턴 판단은 잠시 off)
4) Pivot/Arc 선택 로직을 더 ‘상황별’로 정제
→ ΔC + 좌우 차(lr_diff)로 급U자(sharpU) vs 완만 ㄱ(softL) 를 구분
→ 연속커브에서는 Pivot 임계 완화, softL 구간에서는 가급적 Arc 위주로 돌고 Pivot은 예외 상황에서만 허용
5) Arc 진입·유지·탈출 흐름을 부드럽게 정리
→ Arc 최소시간은 커브 형태(sharpU/softL)에 따라 조정
→ 출구는 ΔC 급개방 + 바깥벽 거리(side_far) + FRONT_CLEAR 기반으로
  “너무 오래 안 끌고, 너무 빨리 안 끊는” 균형 잡힌 복귀 조건 적용
→ Arc 내부에서는 s_arc_phase 로 조향 바이어스를 단계적으로 약화(램프다운) 해서 출구에서 과도하게 더 도는 현상 감소

automode 13
1) 기본 골격은 v12와 동일한 “No-Stop Pivot + Arc” ΔC 기반 로직
2) 정지·후진 없이 Pivot(제자리 회전) 과 Arc(부드러운 커브) 두 모드로만 코너를 처리
3) FRONT_PIVOT / FRONT_ARC / FRONT_CLEAR + ΔC(전방 거리 변화율)로 U자/반커브/출구를 상황별로 구분해서 Pivot/Arc/복귀 시점 결정
4) 시작·비상·속도 제어까지 포함한 ‘실차용 통합 상태머신’
5) 시작 직후 TURN BAN(1.5s) 으로 이상한 초기 회전을 봉인
6) FRONT_TOO_CLOSE 이하에서는 무조건 비상 Pivot 회피 (정지 없음)
7) L/R/C 중 최소값 + ΔC로 속도 거버너를 걸고, 연속 급개방 구간에서는 가속을 살짝 늦춰 출구 흔들림 감소
8) 연속 커브(arc chain)와 방지턱(bump)에 대한 특수 처리 유지
9) 직전 턴 이후 일정 시간은 연속커브 in_chain 윈도우로 보고 의사결정 주기/DRIVE 홀드 시간을 줄여 ㄱ-ㄱ-ㄱ 연속 코너를 빠르게 재결정
10) ΔC 흔들림 패턴 + 거리 대역(C≈45~85cm)으로 방지턱 감지,
    그 구간에서는 drive_forward + speedUp 위주로 “속도 유지/회복”에 집중하고 턴 판단은 잠시 off
11) Arc 진입·유지·탈출의 ‘게이트 + Exit 튜닝’ 유지
12) ΔC + 좌우 거리(lr_diff)로 급 U자(sharpU) vs 완만 ㄱ(softL) 분리 →
    U자는 Arc 최소 시간을 짧게, 완만 ㄱ자는 Arc 위주(softL에서는 Pivot 억제)
13) Arc 안에서는 s_arc_phase 기반으로 바깥바퀴 속도 Down을 단계적으로 줄여 출구에서 과도 회전/후진 경향 없이 부드럽게 직진 복귀
